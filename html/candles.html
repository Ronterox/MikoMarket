<h1 id='money' hx-swap-oob='true'>Winnings: {{ end($closes) }}</h1>
<section id='candles'>
    <?php
    function orderButton(string $order, int $value)
    {
        return "
        <button
            hx-get='/candles.php?{$order}={$value}'
            hx-target='closest .candle-part'
            hx-swap='beforeend'
            class='{$order}'>
            " . ucfirst($order) . "
        </button>";
    }

    function popover($name, $value)
    {
        return "
        <div class='popover'>
            <h1>{$name}: {$value}</h1>
            " . orderButton('call', $value) ."
            " . orderButton('put', $value) ."
        </div>";
    }

    function candle_part(string $class, int $height, array $popover)
    {
        $popover = array_map(fn ($name, $value) => popover($name, $value), array_keys($popover), $popover);
        return "
        <div class='{$class} candle-part' style='height: {$height}vh;'>
            " . implode('', $popover) . "
        </div>";
    }

    foreach ($candles as $candle) :
        extract($candle);
        $close_high = $close > $open;
        $close_low = !$close_high;
        $class = $close_high ? 'candle-green' : 'candle-red';
    ?>
        <div class="candle">
            <?php
            echo candle_part($class . ' line', $close_high ? abs($high - $close) : abs($high - $open), ['High' => $high]);

            $candle_open = candle_part($class, abs($close - $open) + 1, ['Open' => $open]);
            $candle_close = candle_part($class, abs($open - $close) + 1, ['Close' => $close]);
            echo $close_high ? $candle_close . $candle_open : $candle_open . $candle_close;

            echo candle_part($class . ' line', $close_low ? abs($low - $close) : abs($low - $open), ['Low' => $low]);
            ?>
        </div>
    <?php endforeach ?>
</section>
